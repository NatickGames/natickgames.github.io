## Tag-Based Item Generation in Valantis


### How Items Work in Valantis
Valantis doesn't feature items or equipment in the traditional sense. Your character doesn't have equipment or armor, and your abilities are a 5 ability loadout determined at character creation.. You have 2 "weapon" abilities, that are tied to your choice of weapon in your primary and off-hand. You have 2 special abilities that you pick from a combined pool determined by your two class choices. and then you have the choice between the signature abilities of those two classes as your fifth ability. Think of it like your weapon, specials, and ultimate on an overwatch or MOBA character, but adapted to a turn-based tactics combat system.
So, due to the lack of equipment slots and the ability loadout system, Valantis doesn't need traditional items like armor, weapons, or items that can cast spells for you. Items in Valantis, then, end up being more like ability/weapon upgrades that go into slots on each of your abilities in your loadout. You have a limited amount of these you can equip per ability, and they mostly consist of stat-boosts for your character, or additional trigger effects that can happen at various times during gameplay, or modify the ability they're slotted into.
Items are separated into two categories based on which types of abilities they can be equipped to. "Equipment" is for your two weapon abilities, and generally represent physical equipment or training, and "Echoes" are for your three discipline specific abilities, and represent more magical, psychological or mental states that your experience in the world has imprinted on you.  Apart from this distinction of which abilities they can be equipped to, items function largely in the same way. They each have a type (Equipment or Echo), rarity (Common, Rare, Epic, Legendary), one or more effects that they grant while equipped, an icon and a name.
The goal is that items, while functionally serving the purpose of gear and loot in a traditional RPG, will thematically feel like your character is becoming a distinct person through the experiences and quests they've undertaken. I wanted to make sure that item generation provided a lot of variety, so each character you roll has different effects available to them over time, and reflect the adventures that character has had. Item effects should have a legitimate impact on how your character plays, so that two characters that have the same ability loadout will have divergent play patterns over time, as each have different opportunities and strategies opened up to them by their item drops. Finally, though it is largely a singleplayer/co-op experience, I do want to keep an eye towards balance of different items and combinations. There are times where events may pit co-op players against one another, and I don't want that (or facing off against  NPCs) to become a trivial or frustrating experience. The items don't need to, and shouldn't be, perfectly balanced, but I need some guidelines the system can use to keep things generally balanced, and need lots of options and levers to keep things in check if I create items that are too far outside the power curve.
So with these three goals in mind: character identity, enabling varied playstyles, and keeping it balanceable; it was time to work on the generator.     

## Generating the Basics
First, we generate the basic framework for us to work within. We need an item rarity and an item type to be able to construct the rest of the item from. Rarity just picks off of a weighted table, making sure that the rarer types are less frequent. The only caveat here is support for explicitly allowing/disallowing certain rarities. Items are generated with a Context object that supplies any parameters that the caller requested for influencing the generated item output. For rarity, we check and see if a rarity or a set of rarities was specified, and remove any rarities that were not included in that list before selecting from the remaining.
For item type, we do something similar. If an item type is specified, then we pick that type. otherwise we generate Equipment 40% of the time and Echoes 60% of the time. The reason for this uneven distribution is because the player has 2 abilities they can add Equipment to, while they have 3 abilities they can add Echoes to. There is one more aspect to item type selection, if an icon is restricted to a specific item type, we select that item type. In that way, content and game events can specify a specific icon for a quest reward or unique item or something similar, and the generator will handle making sure that item follows the conventions we've set out for items with that icon.

## Effects: Making Items Useful
Now that we know the type and rarity of our item, it's time to give it it's functionality. Even though our ultimate goal is for items to gel thematically with the game and the context in which they're generated, we actually generate items with a "bottom up" approach; starting from the mechanics and effects and layering the theme on top. If you start with a balanced, mechanical effect, which is easier for the generator to quantify, you can then layer some reasonable thematic direction on top of that and let the player fill in the creative gaps in the theming. Like most procedural generation systems, we rely heavily on the player's innate ability to tell a story from connected pieces of data.

With that in mind, how do we design our items mechanically? Each rarity comes with an amount of "effect slots" for the item. Common items get one effect, Rare get two, Epic three and finally, Legendary items get four slots for effects. At the beginning of generation, we also assign a number of "effect points" for the item equal to it's slots. 
Most effects take one point, and so at it's simplest, the generator looks at all applicable effects, and selects one for each slot. There are two complications that make it more complex than just picking as many effects as slots and calling it a day. We have the concept of effect points separate from the amount of slots, because not all effects take one point each. Most effects also have a "doubled" variety which take 2 points to apply. In many cases, the doubled effect is literally the same effect as it would have been normally, but with the numbers roughly doubled. In some cases, there are unique, powerful effects that are locked behind doubled effects, to keep them more rare. So doubled effects are exciting finds on gear. 

In order to get a doubled effect though, you'd have to have the surplus effect points for it. That can happen two different ways. The first is simply that if you have a rare item or above (since they have more than 1 effect slot/point to begin with) you have a chance that your first couple effects might just double, and so you could have a rare item that only has one effect, but it's a doubled effect, rather than the more regular type of rare item that has two normal effects. The second way, is through negative effects. 

When your first effect slot is rolled, negative effects are included in the pool. These might decrease a stat, create some sort of penalty when an action happens, or give you a negative status effect at a given time. In return for this, however, the item generator will award the item with another effect point. This can't happen to common items, because they only have one effect slot anyway, but if you get a negative effect on a rare or greater item, it is going to force the generator to give you at least one doubled effect, because at the end of item generation, it needs to have 0 effect points left if possible, using only the slots it has available for that rarity. To use rare as an example again, the item starts generation with 2 slots and 2 points. If you roll a negative effect, it will use up the slot but actually refund an extra point in addition to not using up a point,. So it now has 1 slot left but 3 points, and will always generate a doubled effect to get as close to 0 as possible. For epic and legendary items, a negative effect will actually guarantee you get at least two doubled effects. While this system means sometimes you can get rare items that are weaker than they would normally be, epic and legendary items have clear advantages when they roll negatives. The hope with this system is to create some diversity in the item effects that are generated, as well as encourage more interesting character builds and loadouts, as you have extra powerful items, with downsides to consider for one ability over another.

At the very beginning of this section I mentioned that the effect selection looks at all "applicable" effects. Before we move on, we need to understand what could make an effect applicable or not. First, negative effects are only applicable when we're looking at the first effect slot, and doubled effects are only applicable when we have more points left than slots or if we pass the "random double" check and have at least 2 points. We also don't allow duplicate effects, so any effects already on the item are ineligible. The most interesting filter however, has to do with making the items more thematic. When effects are being selected for application, they're filtered by a tag system. The context coming into the generator provides two lists of tags, CompatableTags and RestrictedTags. These are passed in by the game when an item is requested. In the case of dialogue events, we can pass in tags that represent the player receiving the item, the NPC giving it, maybe some tags specific to the dialogue that triggered the item generation (like a quest reward dialogue) or any number of other things. These tags are easy, designer friendly ways to massage the item output of the generator. I can pass in some stuff saying, "the character who is giving you this item is a Flameshaper, and they're giving you Gloves," and the generator can use these tags to inform its choices. This makes it more likely, but not guaranteed, that if you talk to this Flameshaper NPC, you'll probably get an Equipment item, perhaps even gloves specifically, that probably enhance stats for Flameshaper characters, or have something to do with fire.  
In order to take advantage of these tags, in the effects data, we define compatible and restricted tags for each effect alongside the rest of it's data. If you pass in tags alluding to Fire and Equipment, then any effects that are tagged as Echo related effects, or Water based effects, might filter themselves out based on the context's restricted tags. Essentially, The more CompatibleTags are shared between the generator context and the effect, the more likely it is to be picked, and if any of the context or effects restricted tags are found in the compatible tags, the effect will be self-selected out of the pool. Finally, there is a positive feedback loop included, as each effect, once selected, will add it's own compatible and restricted tag lists to the generator's context, further filtering subsequent effect choices. This means that for items with many effects, like epic and legendary items, the effects on them will have increasingly high cohesion with each other as they go. This is the first breadcrumb we leave players to help them create a story out of these items.
The effects give the item its mechanical use in the game, and can start to tell a story, but now we need to shift into visually representing that to the player through the item icon itself.

## Sprites: Representing Effects
Compared to the effects generation, sprite generation is pretty simple. We have a database of possible item icons, each tagged with a set of Compatible and RestrictedTags just like the effects were. Now, similarly to how we chose effects with some weighted priority for ones with more shared CompatibleTags, we pick sprites this way too. The only difference is that unlike effects, where we preferred options with more shared tags, for sprites we actually exclude any "neutral" options where none of the tags match. Since we're cautious with RestrictedTags and pretty generous with CompatibleTags, we don't have likely situations where we can't find an option, although if we did we have a backup just in case. For sprites, forcing more explicit compatibility with the tags already on the items means that if we've done our job correctly in the design and tagging phase, every item should visually match the effects and situation the item came from.

## Names: Unique, but Relevant
Finally, we come to naming our items. There's a couple tried-and-true ways of going about naming RPG items in a sort of rule-based fashion. You can go old school and just name the item directly by type: "Sword", "Shield", etc. That's clean, but not very unique or descriptive. For a procedurally generated item that may have varied effects added onto it, it doesn't give a sense of how one sword is different from another. RPGs sometimes adopt this approach for common items that are just bundles of stats, but use unique names for items with special effects, "Blazebringer" is a hard-coded sword that lights your enemies on fire, while "Sword" just kills them the old fashioned way.
On the far other end of the spectrum, you can adopt the "MMO style" prefix and suffix strategy. You have a basic item type name for "Iron Sword", "Round Shield" and the like, but then the effects on the item come with a Prefix or Suffix phrase to add to that basic name. Our fire sword, under this model, may be "Scorching Iron Sword" or "Iron Sword of the Arsonist". You can use prefixes to denote stat modifications and suffixes to explain effects on the weapon, to further explain what the item can do. This works really well for MMOs and games where you might buy or sell items in a shop, or view items on another player, and need a convenient shorthand to get the gist of what the item is about without having to sit and read through all the "Strength + 85, Cast Fireball on Hit, Max Health 120%" descriptions on it. 
For Valantis, I wanted to end up somewhere in the middle. Looking at an item's name should give you a general idea of what it might do, but I also didn't want it to become an obvious system to the player. I wanted the feeling of wielding a weapon or effect that's unique to yourself and you can form a bond with, like Bilbo wielding Thorn or Thor with Mjolnir, while still providing some information at a glance at what that item might do. That meant I was going to have to put some work into generating names that were somehow unique, yet relevant. 
We start with the general idea the prefix and suffix system is based on, but we fuzz the outputs a little bit. Each effect on the item, as well as the sprite, will contribute possible words or "tokens" to the name, keeping the options relevant to the item that's being created, but then we'll generate the name from some templated combination of those, avoiding naming every flaming sword, well, "flaming sword."
To do this, Effects and Sprites have a dictionary of Name Tokens added to their data. These tokens can come from different categories, like Nouns, Adjectives, ItemTypes, Virtues, Elements, Locations, Groups and others. At first, all categories were available to both effects and sprites, but this caused some weird and repetitive combinations. After some testing, I found it was best to restrict more concrete words, like nouns and item types, to the sprites, as they visually represent the item and are more closely linked in the player's mind to what the item *is*. There's a couple of categories that can overlap, like possessive nouns, but for the most part, the more concrete categories are on sprites and the more descriptive or abstract ones are on the effects.
When we generate a name, we gather all the available tokens for the sprite and effects by categories, and then we select a random name template from a set of possible templates. These templates are just a set of phrase structures for replacement, like "{Adjective} {Noun} of {Virtue}" or "{Possessive} {ItemType} of {Element}". The generator looks until it finds a template that it can fill with the categories that the item has available. If none of the effects or the sprite had any Element tokens, then templates using an Element token will be discarded and the next template will be selected.
Once we've got a template and all the tokens, we just select random options from each category to construct the name. Since each effect only has tokens on it that make sense with that effect, and the sprite only includes tokens that make sense with the context of the image, the name ends up coming out as something pretty reasonable, but it's extremely unlikely that you'll have two items with the exact same name in your inventory. 

As an example, I ran the generator on a sprite of a book, which means all of these results share the same sprite tokens, but have different effect tokens available to them based on what effects they rolled. Here is an example of some of the variance in the generated names coming from the same sprite:
 - Volume of Elara
 - Manuscript of Varian
 - Piercing Tome
 - Haunting Codex
 - Seraphina's Compendium of Altrusim

The great part about this system is that as I see sub-par names generated in testing, it's simply a matter of tweaking the weights or adding/removing either name tokens or templates from the various effects and sprites. It's easy to add tokens to commonly used sprites or effects for greater variety, or to remove templates that read awkwardly when generated. When running the tests here to create these examples, I noticed that there were too many results that were just flavor with no mechanical description. Books seemed to pick short templates with little description a little too often, and it was easy to go look at the available templates and tokens on the book sprite and see why this might be the case.
For the player, the result is relatively unique names per item, but by reading the name you get a bit of flavor as to what this item may be or where it's come from, as well as a hint at what it might do mechanically. Piercing Tome, for example, added armor removal to the ability it's attached to. While Haunting Codex applied a Terrified condition to enemies hit by the attached ability.

## Putting it all Together
So, when the game needs to generate an item, either as enemy or chest loot, or as a result of a dialogue or quest reward, we first gather context about who is giving us the item, who is receiving it, and any other context or specific outputs we want, passed to us by the system that calls for the item. 
Once we have that context, we start by generating an appropriate item type and rarity, then use that to select a number of effects. Each effect is shaped by a selection of tags that can make it more or less likely to be generated from the context. Those effects and their tags then get passed to icon generation, which selects an appropriate icon for the item type and tags. Finally, we grab name tokens from the effects and the sprite, and combine them in an appropriate template to create a unique, but relevant name. 
We had three goals for item generation at the start: 1. Creating character identity for each playthrough, 2. Enabling diverse playstyles and 3. Ensuring the system is balanceable. Our randomization of the effects given, and the unique names generated from these effects create a unique experience for each player, with items that are influenced by and reference the player character's choices as well as the content they've seen. 
For the second goal, the variation and nature of the effects, and specifically how they can be equipped to various abilities to change how that attached ability functions, has opened up tons of options for playstyle changes mid-game. In one test run, I got an item that added smokescreens to all tiles hit by an ability. Equipping that to my large AoE transformed that attack from being a primarily offensive tool, to also enabling a smoke bomb style escape move. The choice to use it on my main attack, however, forced me to rely less on my single target melee weapon, as any time I used my big AoE attack, both myself and my enemies now would become untargetable by single target attacks. This is just one example of how an effect modifier might open completely new options to a player while simultaneously giving them new build restrictions or factors to consider.
Finally, both for the thematic aspects like naming and icons, as well as for the effects, this modular, largely data oriented system allows for many different levers for balancing without changing the fundamental system in any way. If something happens to often or is too powerful for how common it is, its easy to adjust the weight of that effect appearing, or make it a doubled effect to lessen it's ubiquity without affecting the excitement of getting that drop when it does happen. Similarly, effects can be tuned on an individual effect level, and the generator simply just uses the new, tuned values. Adding new content is as simple as putting some more options in the pool and adjusting rates if they seem too common or scarce. For the icon and naming system, we can adjust tags to determine roughly when and where the items may show up, without directly assigning items or effect types to each loot table in the game. Edge cases in the naming system can be adjusted easily through adding or removing tokens or templates.
So far in testing, this system has been working well for Valantis. In a game with more traditional items and equipment, this system might not be necessary. In a game with a competitive multiplayer aspect, this sort of effect generation or fuzziness with the naming conventions might be more trouble than it is worth . But for Valantis, it fits the design goals well and has had a transformative effect on playtesting so far. Hopefully there is something here that can be helpful for other developers looking to surprise their players with loot that fits their adventure and their character choices in a way that feels unique to each experience.